{% extends "base.html" %}
{% load static %}
{% load dict_extras %}

{% block css_files %}
 <link rel="stylesheet" href="{% static 'physik/physik.css' %}">
{% endblock %}

{% block content %}
    <div class="page-container">
        <h1>Physiktrainer</h1>
        <div class="table-controls">
            <button type="button" id="toggle-mittel">mittel und profi</button>
            <button type="button" id="toggle-profi">profi</button>
        </div>

        <button type="button" id="openModal">Start</button>

        <div id="overlay" class="modal-overlay hidden">
            <div class="modal">
                <div class="modal-header">
                    <div><strong>Wähle Themenbereich und Schwierigkeitsgrad</strong></div>
                    <button type="button" id="closeModal" class="modal-close">×</button>
                </div>
                <form method="get" action="{% url 'physik:aufgaben' %}">
                    <div class="modal-body">
                        <label>Themenbereich</label>
                        <select name="tb" id="tbSelect" required>
                            <option value="">– bitte wählen –</option>
                            {% for tb in themenbereiche %}
                                <option value="{{ tb.id }}">{{ tb.thema }}</option>
                            {% endfor %}
                        </select>
                        <label>Start-Kapitel (fix)</label>
                            <select id="startSelectDisplay" disabled></select>
                            <input type="hidden" name="start" id="startSelect">
                            <label>End-Kapitel</label>
                        <select name="end" id="endSelect" required></select>
                        <hr>
                        <label>Schwierigkeitsgrad (bis:)</label>
                        <div class="radio-row">
                            <label><input type="radio" name="level" value="1"> Einfach</label>
                            <label><input type="radio" name="level" value="2" required checked> Mittel</label>
                            <label><input type="radio" name="level" value="3"> Profi</label>
                        </div>
                        <label>welches Fach</label>
                            <div class="radio-row">
                                <label><input type="radio" name="fach" value="1" required checked> Fach 1</label>
                                <label><input type="radio" name="fach" value="2"> Fach 2</label>
                                <label><input type="radio" name="fach" value="3"> Fach 3</label>
                            </div>
                            <p class="small text-muted mt-1">Hinweis: Fach 4 (Archiv) kann nicht gezielt geübt werden.</p>

                    </div>
                    <div class="modal-footer">
                        <button type="submit">weiter</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="table-wrapper">
            <table class="physik-tabelle">
                <thead>
                    <tr>
                        <th rowspan="2">Thema / Kapitel</th>
                        <th class="spacer" rowspan="2"></th>
                        <th colspan="5">einfach</th>
                        <th class="spacer" rowspan="2"></th>
                        <th colspan="5" class="col-mittel">mittel</th>
                        <th rowspan="2" class="col-mittel">Σ<br>E+M</th>
                        <th class="spacer" rowspan="2"></th>
                        <th colspan="5" class="col-profi">profi</th>
                        <th rowspan="2" class="col-profi">Σ<br>gesamt</th>
                    </tr>
                    <tr>
                        {# Umbenennung auf 1, 2, 3, Archiv (4) #}
                        <th>1</th><th>2</th><th>3</th><th>Archiv</th><th>Σ</th>
                        <th class="col-mittel">1</th><th class="col-mittel">2</th><th class="col-mittel">3</th><th class="col-mittel">Archiv</th><th class="col-mittel">Σ</th>
                        <th class="col-profi">1</th><th class="col-profi">2</th><th class="col-profi">3</th><th class="col-profi">Archiv</th><th class="col-profi">Σ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tb in themenbereiche %}
                        <tr class="themenbereich thementitel" style="background: {{ tb.farbe }}; cursor: pointer;" data-target="tb-{{ tb.id }}">
                            <td class="tb-title">{{ tb.thema }}</td>
                            <td class="spacer"></td>
                            <td colspan="5"></td>
                            <td class="spacer col-mittel"></td>
                            <td colspan="6" class="col-mittel"></td>
                            <td class="spacer col-profi"></td>
                            <td colspan="6" class="col-profi"></td>
                        </tr>
                        {% for kap in tb.kapitel.all %}
                            {% with tb_map=counts|get_item:tb.id %}
                            {% with kap_data=tb_map|get_item:kap.id %}
                                {% if kap_data %}
                                    <tr class="kapitel tb-{{ tb.id }}">
                                        <td class="kapitel-name">{{ kap.zeile }}. {{ kap.kapitel }}</td>
                                        <td class="spacer"></td>
                                        {# --- EINFACH (Level 1) --- #}
                                        {% with s1=kap_data|get_item:"1" %}
                                            {% with f1=s1|get_item:0|default:0 f2=s1|get_item:1|default:0 f3=s1|get_item:2|default:0 f4=s1|get_item:3|default:0 total=s1|get_item:"total"|default:0 %}
                                            {# Wir berechnen, ob schon etwas "raus" ist (Summe von Fach 2, 3 und 4) #}
                                            {% with weg=f2|add:f3|add:f4 %}
                                                <td class="box" style="background-color: 
                                                    {% if total == 0 %}transparent
                                                    {% elif f1 == 0 %}#c8e6c9; /* GRÜN: Fach 1 ist leer */
                                                    {% elif weg > 0 %}#fff9c4; /* GELB: In Arbeit (etwas ist in Fach 2+) */
                                                    {% else %}#ffcc80; /* ORANGE: Noch nichts bewegt */
                                                    {% endif %};">
                                                    {% if f1 > 0 %}
                                                        <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=1&fach=1" style="color: inherit; text-decoration: none; display: block;">
                                                            {{ f1 }}
                                                        </a>
                                                    {% else %} 0 {% endif %}
                                                </td>
                                                {# Fach 2 #}
                                                <td class="box" style="background-color: {% if total == 0 %}transparent{% elif f2 == 0 and total > 0 and f1 == 0 %}#c8e6c9{% elif f2 > 0 %}#fff9c4{% else %}transparent{% endif %};">
                                                    {% if f2 > 0 %}
                                                        <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=1&fach=2" style="color: inherit; text-decoration: none; display: block;">{{ f2 }}</a>
                                                    {% else %} 0 {% endif %}
                                                </td>
                                                {# Fach 3 #}
                                                <td class="box" style="background-color: {% if total == 0 %}transparent{% elif f3 == 0 and total > 0 and f1 == 0 and f2 == 0 %}#c8e6c9{% elif f3 > 0 %}#fff9c4{% else %}transparent{% endif %};">
                                                    {% if f3 > 0 %}
                                                        <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=1&fach=3" style="color: inherit; text-decoration: none; display: block;">{{ f3 }}</a>
                                                    {% else %} 0 {% endif %}
                                                </td>
                                                {# Fach 4 (Das Ziel) #}
                                                <td class="box" style="background-color: {% if total > 0 and f4 == total %}#4caf50{% elif f4 > 0 %}#c8e6c9{% else %}transparent{% endif %}; {% if total > 0 and f4 == total %}color: white;{% endif %}">
                                                    {{ f4 }}
                                                </td>
                                                {# Summe Level 1 #}
                                                <td class="summe" style="background: {{ tb.farbe }};">
                                                    {{ total }}
                                                </td>
                                            {% endwith %}
                                            {% endwith %}
                                        {% endwith %}

                                        <td class="spacer"></td>

                                        {# --- MITTEL (Level 2) --- #}
                                        {% with s2=kap_data|get_item:"2" %}
                                            {% with f1=s2|get_item:0|default:0 f2=s2|get_item:1|default:0 f3=s2|get_item:2|default:0 f4=s2|get_item:3|default:0 total2=s2|get_item:"total"|default:0 %}
                                            {# Hilfsvariable für Fach 1 Status #}
                                            {% with weg_aus_f1=f2|add:f3|add:f4 %}

                                            {# Fach 1 #}
                                            <td class="box col-mittel" style="background-color: {% if total2 == 0 %}transparent{% elif f1 == 0 %}#c8e6c9{% elif weg_aus_f1 > 0 %}#fff9c4{% else %}#ffcc80{% endif %};">
                                                {% if f1 > 0 %}
                                                    <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=2&fach=1" style="color: inherit; text-decoration: none; display: block;">{{ f1 }}</a>
                                                {% else %} 0 {% endif %}
                                            </td>

                                            {# Fach 2 #}
                                            <td class="box col-mittel">
                                                {% with s2=counts|get_item:tb.id|get_item:kap.id|get_item:"2" %}
                                                    {% if s2.kum_f2 > 0 %}
                                                        {% if s2.f2_ready %}
                                                            <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=2&fach=2" 
                                                            style="color: inherit; text-decoration: none; display: block;">
                                                                {{ f2 }}
                                                            </a>
                                                        {% else %}
                                                            <span style="color: #bbb; display: block;" title="{{ s2.f2_hint }}">{{ f2 }}</span>
                                                        {% endif %}
                                                    {% else %} 0 {% endif %}
                                                {% endwith %}
                                            </td>

                                            {# Fach 3 #}
                                            <td class="box col-mittel">
                                                {% with s2=counts|get_item:tb.id|get_item:kap.id|get_item:"2" %}
                                                    {% if s2.kum_f3 > 0 %}
                                                        {% if s2.f3_ready %}
                                                            <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=2&fach=3" 
                                                            style="color: inherit; text-decoration: none; display: block;">
                                                                {{ f3 }}
                                                            </a>
                                                        {% else %}
                                                            <span style="color: #bbb; display: block;" title="{{ s2.f3_hint }}">{{ f3 }}</span>
                                                        {% endif %}
                                                    {% else %} 0 {% endif %}
                                                {% endwith %}
                                            </td>

                                            {# Fach 4 (Archiv) #}
                                            <td class="box col-mittel" style="background-color: {% if total2 > 0 and f4 == total2 %}#4caf50{% elif f4 > 0 %}#c8e6c9{% else %}transparent{% endif %}; {% if total2 > 0 and f4 == total2 %}color: white;{% endif %}">
                                                {{ f4 }}
                                            </td>

                                            {# Summe Level 2 #}
                                            <td class="summe col-mittel" style="background: {{ tb.farbe }};">
                                                {{ total2 }}
                                            </td>

                                            {# Gesamtsumme (Level 1 + Level 2) #}
                                            <td class="summe col-mittel" style="background: {{ tb.farbe }}; font-weight: bold; border-left: 2px solid rgba(0,0,0,0.1);">
                                                {% with s1=kap_data|get_item:"1" %}
                                                    {% with total1=s1|get_item:"total"|default:0 %}
                                                        {{ total1|add:total2 }}
                                                    {% endwith %}
                                                {% endwith %}
                                            </td>

                                            {% endwith %}
                                            {% endwith %}
                                        {% endwith %}

                                        <td class="spacer col-mittel"></td>

                                        {# --- PROFI (Level 3) --- #}
                                        {% with s3=kap_data|get_item:"3" %}
                                            {% with f1=s3|get_item:0|default:0 f2=s3|get_item:1|default:0 f3=s3|get_item:2|default:0 f4=s3|get_item:3|default:0 total3=s3|get_item:"total"|default:0 %}
                                            {# Hilfsvariable für Fach 1 Status #}
                                            {% with weg_aus_f1=f2|add:f3|add:f4 %}
                                                {# Fach 1 #}
                                                <td class="box col-profi" style="background-color: {% if total3 == 0 %}transparent{% elif f1 == 0 %}#c8e6c9{% elif weg_aus_f1 > 0 %}#fff9c4{% else %}#ffcc80{% endif %};">
                                                    {% if f1 > 0 %}
                                                        <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=3&fach=1" style="color: inherit; text-decoration: none; display: block;">{{ f1 }}</a>
                                                    {% else %} 0 {% endif %}
                                                </td>

                                                {# Fach 2 #}
                                                <td class="box col-profi" style="background-color: {% if total3 == 0 %}transparent{% elif f2 > 0 %}#fff9c4{% elif f2 == 0 and f3|add:f4 > 0 %}#c8e6c9{% else %}transparent{% endif %};">
                                                    {% if f2 > 0 %}
                                                        <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=3&fach=2" style="color: inherit; text-decoration: none; display: block;">{{ f2 }}</a>
                                                    {% else %} 0 {% endif %}
                                                </td>

                                                {# Fach 3 #}
                                                <td class="box col-profi" style="background-color: {% if total3 == 0 %}transparent{% elif f3 > 0 %}#fff9c4{% elif f3 == 0 and f4 > 0 %}#c8e6c9{% else %}transparent{% endif %};">
                                                    {% if f3 > 0 %}
                                                        <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=3&fach=3" style="color: inherit; text-decoration: none; display: block;">{{ f3 }}</a>
                                                    {% else %} 0 {% endif %}
                                                </td>

                                                {# Fach 4 (Archiv/Ziel) #}
                                                <td class="box col-profi" style="background-color: {% if total3 > 0 and f4 == total3 %}#4caf50{% elif f4 > 0 %}#c8e6c9{% else %}transparent{% endif %}; {% if total3 > 0 and f4 == total3 %}color: white;{% endif %}">
                                                    {{ f4 }}
                                                </td>

                                                {# Summe Level 3 #}
                                                <td class="summe col-profi" style="background: {{ tb.farbe }};">
                                                    {{ total3 }}
                                                </td>

                                                {# Gesamtsumme (Level 1 + Level 2 + Level 3) #}
                                                <td class="summe col-profi" style="background: {{ tb.farbe }}; font-weight: bold; border-left: 2px solid rgba(0,0,0,0.1);">
                                                    {% with s1=kap_data|get_item:"1" s2=kap_data|get_item:"2" %}
                                                        {% with t1=s1|get_item:"total"|default:0 t2=s2|get_item:"total"|default:0 %}
                                                            {{ t1|add:t2|add:total3 }}
                                                        {% endwith %}
                                                    {% endwith %}
                                                </td>
                                            {% endwith %}
                                            {% endwith %}
                                        {% endwith %}                                
                                    </tr>
                                {% endif %}
                            {% endwith %}
                            {% endwith %}
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {{ kapitel_map|json_script:"kapitel-data" }}


    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const body = document.body;

            document.getElementById("toggle-mittel")?.addEventListener("click", () => {
                body.classList.toggle("hide-mittel");
                // Logik: Wenn Mittel weg, muss Profi auch weg
                if (body.classList.contains("hide-mittel")) {
                    body.classList.add("hide-profi");
                }
            });

            document.getElementById("toggle-profi")?.addEventListener("click", () => {
                // Profi darf nur sichtbar sein, wenn Mittel auch da ist
                if (body.classList.contains("hide-mittel")) {
                    body.classList.add("hide-profi");
                    return;
                }
                body.classList.toggle("hide-profi");
            });
        });
    </script>

    <script>
        (function() {
            document.addEventListener("DOMContentLoaded", function() {
                // Erst jetzt ist sichergestellt, dass "kapitel-data" existiert
                var dataTag = document.getElementById("kapitel-data");
                if (!dataTag) {
                    console.error("Datentopf nicht gefunden");
                    return;
                }

                var kapitelMap = {};
                try {
                    kapitelMap = JSON.parse(dataTag.textContent);
                    console.log("Kapitel geladen:", Object.keys(kapitelMap));
                } catch (e) {
                    console.error("JSON Error", e);
                }

                var tbSelect = document.getElementById("tbSelect");
                var openBtn = document.getElementById("openModal");
                var overlay = document.getElementById("overlay");
                var startDisplay = document.getElementById("startSelectDisplay");
                var startHidden = document.getElementById("startSelect");
                var endSelect = document.getElementById("endSelect");

                function fill(tbId) {
                    var liste = kapitelMap[tbId] || [];
                    if (startDisplay && endSelect) {
                        startDisplay.innerHTML = "";
                        endSelect.innerHTML = "";
                        liste.forEach(function(k) {
                            var opt = new Option(k.zeile + ". " + k.name, k.zeile);
                            startDisplay.add(opt.cloneNode(true));
                            endSelect.add(opt);
                        });

                        if (liste.length > 0) {
                            startDisplay.value = liste[0].zeile;
                            if(startHidden) startHidden.value = liste[0].zeile;
                            endSelect.value = liste[liste.length - 1].zeile;
                        }
                    }
                }

                if (openBtn) {
                    openBtn.onclick = function() {
                        overlay.classList.remove("hidden");
                        if (tbSelect.value) fill(tbSelect.value);
                    };
                }

                if (tbSelect) {
                    tbSelect.onchange = function(e) { fill(e.target.value); };
                }
                
                document.getElementById("closeModal").onclick = function() { 
                    overlay.classList.add("hidden"); 
                };

                // Einklapp-Logik
                document.querySelectorAll(".thementitel").forEach(function(balken) {
                    balken.onclick = function() {
                        var target = this.getAttribute("data-target");
                        document.querySelectorAll("." + target).forEach(function(row) {
                            row.classList.toggle("hidden");
                        });
                    };
                });
            });
        })();
    </script>
{% endblock %}