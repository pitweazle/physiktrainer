{% extends "base.html" %}
{% load static %}
{% load dict_extras %}

{% block body_classes %}
    {% with profil=request.user.physik_profil %}
        {% if 'mittel' in profil.details.versteckt %}hide-mittel hide-profi{% endif %}
        {% if 'profi' in profil.details.versteckt and 'mittel' not in profil.details.versteckt %}hide-profi{% endif %}
    {% endwith %}
{% endblock %}

{% block css_files %}
    <link rel="stylesheet" href="{% static 'physik/physik.css' %}">

<style>
    /* Wir schreiben im Head KEIN display:none mehr f√ºr die IDs!
       Stattdessen nutzen wir die Klasse .hidden, die dein JS auch verwendet.
    */
    .hidden { display: none !important; }
</style>

<script>
    /* Wir setzen die Initial-Zust√§nde so, wie dein JS sie erwartet:
       √úber Klassen, nicht √ºber feste CSS-Regeln.
    */
    document.addEventListener("DOMContentLoaded", function() {
        const body = document.body;

        {% if profil and profil.physik_einstellungen %}
            
            // 1. Spalten-Zustand wiederherstellen
            {% if 'mittel' in profil.physik_einstellungen.versteckt %}
                body.classList.add("hide-mittel", "hide-profi");
            {% elif 'profi' in profil.physik_einstellungen.versteckt %}
                body.classList.add("hide-profi");
            {% endif %}

            // 2. Zeilen-Zustand wiederherstellen
            {% for id in profil.physik_einstellungen.zeilen_versteckt %}
                document.querySelectorAll(".{{ id }}").forEach(el => {
                    el.classList.add("hidden");
                });
            {% endfor %}

        {% endif %}
    });
</script>
{% endblock %}

{% block content %}
    <nav>
        <div class="nav-links">

            {% if user.is_staff %}
                <span class="nav-divider">| Lehrer-Tools:</span>
                
                <a href="{% url 'physik:aufgaben_liste' %}">üìã Inventar</a>
                <a href="{% url 'physik:fehler_liste' %}">üìä Analyse</a>
                <a href="{% url 'physik:howto' %}">‚ùì Anleitung (HowTo)</a>
                
                <a href="/admin/" target="_blank" class="admin-link">‚öôÔ∏è Admin</a>
            {% endif %}
        </div>

<a href="#" class="btn-call" onclick="frageLfdNrAb()">üîç Aufgabe direkt aufrufen</a>

<script>
function frageLfdNrAb() {
    // √ñffnet ein Eingabefenster im Browser
    let nr = prompt("Bitte die laufende Nummer eingeben (z. B. E025_Do):");
    
    // Wenn der User nicht auf "Abbrechen" geklickt hat und das Feld nicht leer ist
    if (nr && nr.trim() !== "") {
        window.location.href = "/call/" + encodeURIComponent(nr.trim()) + "/";
    }
}
</script>


    </nav>

    <div class="page-container">
        <h1>Physiktrainer</h1>
        <div class="table-controls">
            <button type="button" id="toggle-mittel">mittel und profi</button>
            <button type="button" id="toggle-profi">profi</button>
        </div>

        <button type="button" id="openModal">Start</button>

        <div id="overlay" class="modal-overlay hidden">
            <div class="modal">
                <div class="modal-header">
                    <div><strong>W√§hle Themenbereich und Schwierigkeitsgrad</strong></div>
                    <button type="button" id="closeModal" class="modal-close">√ó</button>
                </div>
                <form method="get" action="{% url 'physik:aufgaben' %}">
                    <div class="modal-body">
                        <label>Themenbereich</label>
                        <select name="tb" id="tbSelect" required>
                            <option value="">‚Äì bitte w√§hlen ‚Äì</option>
                            {% for tb in themenbereiche %}
                                <option value="{{ tb.id }}">{{ tb.thema }}</option>
                            {% endfor %}
                        </select>
                        <label>Start-Kapitel (fix)</label>
                            <select id="startSelectDisplay" disabled></select>
                            <input type="hidden" name="start" id="startSelect">
                            <label>End-Kapitel</label>
                        <select name="end" id="endSelect" required></select>
                        <hr>
                        <label>Schwierigkeitsgrad (bis:)</label>
                        <div class="radio-row">
                            <label><input type="radio" name="level" value="1"> Einfach</label>
                            <label><input type="radio" name="level" value="2" required checked> Mittel</label>
                            <label><input type="radio" name="level" value="3"> Profi</label>
                        </div>
                        <label>welches Fach</label>
                            <div class="radio-row">
                                <label><input type="radio" name="fach" value="1" required checked> Fach 1</label>
                                <label><input type="radio" name="fach" value="2"> Fach 2</label>
                                <label><input type="radio" name="fach" value="3"> Fach 3</label>
                            </div>
                            <p class="small text-muted mt-1">Hinweis: Fach 4 (Archiv) kann nicht gezielt ge√ºbt werden.</p>

                    </div>
                    <div class="modal-footer">
                        <button type="submit">weiter</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="table-wrapper">
            <table class="physik-tabelle">
                <thead>
                    <tr>
                        <th rowspan="2">Thema / Kapitel</th>
                        <th class="spacer" rowspan="2"></th>
                        <th colspan="5">einfach</th>
                        <th class="spacer" rowspan="2"></th>
                        <th colspan="5" class="col-mittel">mittel</th>
                        <th rowspan="2" class="col-mittel">Œ£<br>E+M</th>
                        <th class="spacer" rowspan="2"></th>
                        <th colspan="5" class="col-profi">profi</th>
                        <th rowspan="2" class="col-profi">Œ£<br>gesamt</th>
                    </tr>
                    <tr>
                        {# Umbenennung auf 1, 2, 3, Archiv (4) #}
                        <th>1</th><th>2</th><th>3</th><th>Archiv</th><th>Œ£</th>
                        <th class="col-mittel">1</th><th class="col-mittel">2</th><th class="col-mittel">3</th><th class="col-mittel">Archiv</th><th class="col-mittel">Œ£</th>
                        <th class="col-profi">1</th><th class="col-profi">2</th><th class="col-profi">3</th><th class="col-profi">Archiv</th><th class="col-profi">Œ£</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tb in themenbereiche %}
                        <tr class="themenbereich thementitel" style="background: {{ tb.farbe }}; cursor: pointer;" data-target="tb-{{ tb.id }}">
                            <td class="tb-title">{{ tb.thema }}</td>
                            <td class="spacer"></td>
                            <td colspan="5"></td>
                            <td class="spacer col-mittel"></td>
                            <td colspan="6" class="col-mittel"></td>
                            <td class="spacer col-profi"></td>
                            <td colspan="6" class="col-profi"></td>
                        </tr>
                        {% for kap in tb.kapitel.all %}
                            {% with tb_map=counts|get_item:tb.id %}
                            {% with kap_data=tb_map|get_item:kap.id %}
                                {% if kap_data %}
                                    <tr class="kapitel tb-{{ tb.id }}">
                                        <td class="kapitel-name">{{ kap.zeile }}. {{ kap.kapitel }}</td>
                                        <td class="spacer"></td>
                                        {# --- EINFACH (Level 1) --- #}
                                        {% with s1=kap_data|get_item:"1" %}
                                            {% with f1=s1|get_item:0|default:0 f2=s1|get_item:1|default:0 f3=s1|get_item:2|default:0 f4=s1|get_item:3|default:0 total=s1|get_item:"total"|default:0 %}
                                            {# Wir berechnen, ob schon etwas "raus" ist (Summe von Fach 2, 3 und 4) #}
                                            {% with weg=f2|add:f3|add:f4 %}
                                                <td class="box" style="background-color: 
                                                    {% if total == 0 %}transparent
                                                    {% elif f1 == 0 %}#c8e6c9; /* GR√úN: Fach 1 ist leer */
                                                    {% elif weg > 0 %}#fff9c4; /* GELB: In Arbeit (etwas ist in Fach 2+) */
                                                    {% else %}#ffcc80; /* ORANGE: Noch nichts bewegt */
                                                    {% endif %};">
                                                    {% if f1 > 0 %}
                                                        <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=1&fach=1" style="color: inherit; text-decoration: none; display: block;">
                                                            {{ f1 }}
                                                        </a>
                                                    {% else %} 0 {% endif %}
                                                </td>
                                                <td class="box col-einfach">
                                                    {% with s1=counts|get_item:tb.id|get_item:kap.id|get_item:"1" %}
                                                        {% if s1.kum_f2 > 0 %}
                                                            {% if s1.f2_ready %}
                                                                <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=1&fach=2" 
                                                                style="color: inherit; text-decoration: none; display: block;">
                                                                    {{ f2 }}
                                                                </a>
                                                            {% else %}
                                                                <span style="color: #bbb; display: block;" title="{{ s1.f2_hint }}">
                                                                    {{ f2 }}
                                                                </span>
                                                            {% endif %}
                                                        {% else %} 0 {% endif %}
                                                    {% endwith %}
                                                </td>
                                                <td class="box col-einfach">
                                                    {% with s1=counts|get_item:tb.id|get_item:kap.id|get_item:"1" %}
                                                        {% if s1.kum_f3 > 0 %}
                                                            {% if s1.f3_ready %}
                                                                <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=1&fach=3" 
                                                                style="color: inherit; text-decoration: none; display: block;">
                                                                    {{ f3 }}
                                                                </a>
                                                            {% else %}
                                                                <span style="color: #bbb; display: block;" title="{{ s1.f3_hint }}">
                                                                    {{ f3 }}
                                                                </span>
                                                            {% endif %}
                                                        {% else %} 0 {% endif %}
                                                    {% endwith %}
                                                </td>
                                                {# Fach 4 (Das Ziel) #}
                                                <td class="box" style="background-color: {% if total > 0 and f4 == total %}#4caf50{% elif f4 > 0 %}#c8e6c9{% else %}transparent{% endif %}; {% if total > 0 and f4 == total %}color: white;{% endif %}">
                                                    {{ f4 }}
                                                </td>
                                                {# Summe Level 1 #}
                                                <td class="summe" style="background: {{ tb.farbe }};">
                                                    {{ total }}
                                                </td>
                                            {% endwith %}
                                            {% endwith %}
                                        {% endwith %}

                                        <td class="spacer"></td>

                                        {# --- MITTEL (Level 2) --- #}
                                        {% with s2=kap_data|get_item:"2" %}
                                            {% with f1=s2|get_item:0|default:0 f2=s2|get_item:1|default:0 f3=s2|get_item:2|default:0 f4=s2|get_item:3|default:0 total2=s2|get_item:"total"|default:0 %}
                                            {# Hilfsvariable f√ºr Fach 1 Status #}
                                            {% with weg_aus_f1=f2|add:f3|add:f4 %}

                                            {# Fach 1 #}
                                            <td class="box col-mittel" style="background-color: {% if total2 == 0 %}transparent{% elif f1 == 0 %}#c8e6c9{% elif weg_aus_f1 > 0 %}#fff9c4{% else %}#ffcc80{% endif %};">
                                                {% if f1 > 0 %}
                                                    <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=2&fach=1" style="color: inherit; text-decoration: none; display: block;">{{ f1 }}</a>
                                                {% else %} 0 {% endif %}
                                            </td>

                                            {# Fach 2 #}
                                            <td class="box col-mittel">
                                                {% with s2=counts|get_item:tb.id|get_item:kap.id|get_item:"2" %}
                                                    {% if s2.kum_f2 > 0 %}
                                                        {% if s2.f2_ready %}
                                                            <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=2&fach=2" 
                                                            style="color: inherit; text-decoration: none; display: block;">
                                                                {{ f2 }}
                                                            </a>
                                                        {% else %}
                                                            <span style="color: #bbb; display: block;" title="{{ s2.f2_hint }}">{{ f2 }}</span>
                                                        {% endif %}
                                                    {% else %} 0 {% endif %}
                                                {% endwith %}
                                            </td>

                                            {# Fach 3 #}
                                            <td class="box col-mittel">
                                                {% with s2=counts|get_item:tb.id|get_item:kap.id|get_item:"2" %}
                                                    {% if s2.kum_f3 > 0 %}
                                                        {% if s2.f3_ready %}
                                                            <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=2&fach=3" 
                                                            style="color: inherit; text-decoration: none; display: block;">
                                                                {{ f3 }}
                                                            </a>
                                                        {% else %}
                                                            <span style="color: #bbb; display: block;" title="{{ s2.f3_hint }}">{{ f3 }}</span>
                                                        {% endif %}
                                                    {% else %} 0 {% endif %}
                                                {% endwith %}
                                            </td>

                                            {# Fach 4 (Archiv) #}
                                            <td class="box col-mittel" style="background-color: {% if total2 > 0 and f4 == total2 %}#4caf50{% elif f4 > 0 %}#c8e6c9{% else %}transparent{% endif %}; {% if total2 > 0 and f4 == total2 %}color: white;{% endif %}">
                                                {{ f4 }}
                                            </td>

                                            {# Summe Level 2 #}
                                            <td class="summe col-mittel" style="background: {{ tb.farbe }};">
                                                {{ total2 }}
                                            </td>

                                            {# Gesamtsumme (Level 1 + Level 2) #}
                                            <td class="summe col-mittel" style="background: {{ tb.farbe }}; font-weight: bold; border-left: 2px solid rgba(0,0,0,0.1);">
                                                {% with s1=kap_data|get_item:"1" %}
                                                    {% with total1=s1|get_item:"total"|default:0 %}
                                                        {{ total1|add:total2 }}
                                                    {% endwith %}
                                                {% endwith %}
                                            </td>

                                            {% endwith %}
                                            {% endwith %}
                                        {% endwith %}

                                        <td class="spacer col-mittel"></td>

                                        {# --- PROFI (Level 3) --- #}
                                        {% with s3=kap_data|get_item:"3" %}
                                            {% with f1=s3|get_item:0|default:0 f2=s3|get_item:1|default:0 f3=s3|get_item:2|default:0 f4=s3|get_item:3|default:0 total3=s3|get_item:"total"|default:0 %}
                                            {# Hilfsvariable f√ºr Fach 1 Status #}
                                            {% with weg_aus_f1=f2|add:f3|add:f4 %}
                                                {# Fach 1 #}
                                                <td class="box col-profi" style="background-color: {% if total3 == 0 %}transparent{% elif f1 == 0 %}#c8e6c9{% elif weg_aus_f1 > 0 %}#fff9c4{% else %}#ffcc80{% endif %};">
                                                    {% if f1 > 0 %}
                                                        <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=3&fach=1" style="color: inherit; text-decoration: none; display: block;">{{ f1 }}</a>
                                                    {% else %} 0 {% endif %}
                                                </td>

                                                <td class="box col-profi">
                                                    {% with s3=counts|get_item:tb.id|get_item:kap.id|get_item:"3" %}
                                                        {% if s3.kum_f2 > 0 %}
                                                            {% if s3.f2_ready %}
                                                                <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=3&fach=2" 
                                                                style="color: inherit; text-decoration: none; display: block;">
                                                                    {{ f2 }}
                                                                </a>
                                                            {% else %}
                                                                <span style="color: #bbb; display: block;" title="{{ s3.f2_hint }}">
                                                                    {{ f2 }}
                                                                </span>
                                                            {% endif %}
                                                        {% else %} 0 {% endif %}
                                                    {% endwith %}
                                                </td>

                                                <td class="box col-profi">
                                                    {% with s3=counts|get_item:tb.id|get_item:kap.id|get_item:"3" %}
                                                        {% if s3.kum_f3 > 0 %}
                                                            {% if s3.f3_ready %}
                                                                <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=3&fach=3" 
                                                                style="color: inherit; text-decoration: none; display: block;">
                                                                    {{ f3 }}
                                                                </a>
                                                            {% else %}
                                                                <span style="color: #bbb; display: block;" title="{{ s3.f3_hint }}">
                                                                    {{ f3 }}
                                                                </span>
                                                            {% endif %}
                                                        {% else %} 0 {% endif %}
                                                    {% endwith %}
                                                </td>

                                                {# Fach 4 (Archiv/Ziel) #}
                                                <td class="box col-profi" style="background-color: {% if total3 > 0 and f4 == total3 %}#4caf50{% elif f4 > 0 %}#c8e6c9{% else %}transparent{% endif %}; {% if total3 > 0 and f4 == total3 %}color: white;{% endif %}">
                                                    {{ f4 }}
                                                </td>

                                                {# Summe Level 3 #}
                                                <td class="summe col-profi" style="background: {{ tb.farbe }};">
                                                    {{ total3 }}
                                                </td>

                                                {# Gesamtsumme (Level 1 + Level 2 + Level 3) #}
                                                <td class="summe col-profi" style="background: {{ tb.farbe }}; font-weight: bold; border-left: 2px solid rgba(0,0,0,0.1);">
                                                    {% with s1=kap_data|get_item:"1" s2=kap_data|get_item:"2" %}
                                                        {% with t1=s1|get_item:"total"|default:0 t2=s2|get_item:"total"|default:0 %}
                                                            {{ t1|add:t2|add:total3 }}
                                                        {% endwith %}
                                                    {% endwith %}
                                                </td>
                                            {% endwith %}
                                            {% endwith %}
                                        {% endwith %}                                
                                    </tr>
                                {% endif %}
                            {% endwith %}
                            {% endwith %}
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {{ kapitel_map|json_script:"kapitel-data" }}

<script>
document.addEventListener("DOMContentLoaded", () => {
    const body = document.body;

    // Hilfsfunktion zum Speichern (Spalten) - nutzt jetzt korrekt den Parameter 'slug'
    function syncSpalten(slug) {
        // WICHTIG: Hier waren die Anf√ºhrungszeichen und Plus-Zeichen falsch
        fetch(`/view-einstellung/${slug}/`) 
            .then(response => response.json())
            .then(data => console.log("Spalten gespeichert:", data))
            .catch(error => console.error("Fehler beim Speichern der Spalten:", error));
    }

    // Hilfsfunktion zum Speichern (Zeilen) - nutzt jetzt korrekt den Parameter 'slug'
    function syncZeilen(slug) {
        fetch(`/row-einstellung/${slug}/`)
            .then(response => response.json())
            .then(data => console.log("Zeile gespeichert:", data))
            .catch(error => console.error("Fehler beim Speichern der Zeile:", error));
    }

    // Event-Listener f√ºr die Buttons (Spalten)
    document.getElementById("toggle-mittel")?.addEventListener("click", function() {
        const isHidden = body.classList.toggle("hide-mittel");
        if (isHidden) body.classList.add("hide-profi");
        syncSpalten('mittel'); // Hier wird der 'slug' √ºbergeben
    });

    document.getElementById("toggle-profi")?.addEventListener("click", function() {
        if (body.classList.contains("hide-mittel")) return;
        body.classList.toggle("hide-profi");
        syncSpalten('profi');
    });

    // Event-Listener f√ºr die Themen-Balken (Zeilen)
    document.querySelectorAll(".thementitel").forEach(balken => {
        balken.onclick = function() {
            // Wir holen den Wert aus data-target (z.B. "tb-2")
            const slug = this.getAttribute("data-target"); 
            
            // Ein-/Ausblenden der Zeilen
            document.querySelectorAll("." + slug).forEach(row => {
                row.classList.toggle("hidden");
            });
            
            // Speichern im Profil
            syncZeilen(slug);
        };
    });
});
</script>

{% endblock %}