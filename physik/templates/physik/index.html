{% extends "base.html" %}
{% load static %}
{% load dict_extras %}

{% block css_files %}
 <link rel="stylesheet" href="{% static 'physik/physik.css' %}">
{% endblock %}

{% block content %}
  <div class="page-container">
      <h1>Physiktrainer</h1>
      <div class="table-controls">
          <button type="button" id="toggle-mittel">mittel und profi</button>
          <button type="button" id="toggle-profi">profi</button>
      </div>


<button type="button" id="openModal">Start</button>

{{ kapitel_map|json_script:"kapitel-data" }}

<div id="overlay" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <div><strong>WÃ¤hle Themenbereich und Schwierigkeitsgrad</strong></div>
      <button type="button" id="closeModal" class="modal-close">Ã—</button>
    </div>

    <form method="get" action="{% url 'physik:aufgaben' %}">
      <div class="modal-body">

        <label>Themenbereich</label>
        <select name="tb" id="tbSelect" required>
          <option value="">â€“ bitte wÃ¤hlen â€“</option>
          {% for tb in themenbereiche %}
            <option value="{{ tb.id }}">{{ tb.thema }}</option>
          {% endfor %}
        </select>

        <label>Schwierigkeitsgrad (bis:)</label>
        <div class="radio-row">
          <label><input type="radio" name="level" value="1" required> Einfach</label>
          <label><input type="radio" name="level" value="2"> Mittel</label>
          <label><input type="radio" name="level" value="3"> Profi</label>
        </div>

        <hr>

        <!-- ðŸ”¹ START: sichtbar, aber NICHT editierbar -->
        <label>Start-Kapitel (fix)</label>
        <select id="startSelectDisplay" disabled></select>

        <!-- ðŸ”¹ versteckt: wird wirklich an den Server geschickt -->
        <input type="hidden" name="start" id="startSelect">

        <label>End-Kapitel</label>
        <select name="end" id="endSelect" required></select>

      </div>

      <div class="modal-footer">
        <button type="submit">weiter</button>
      </div>
    </form>
  </div>
</div>

<script>
(() => {
  const overlay = document.getElementById("overlay");
  const openBtn = document.getElementById("openModal");
  const closeBtn = document.getElementById("closeModal");

  const tbSelect = document.getElementById("tbSelect");
  const startDisplay = document.getElementById("startSelectDisplay");
  const startHidden = document.getElementById("startSelect");
  const endSelect = document.getElementById("endSelect");

  const kapitelMap = JSON.parse(
    document.getElementById("kapitel-data").textContent
  );

  function fillKapitel(tbId) {
    const list = kapitelMap[tbId] || [];

    // Alte Optionen lÃ¶schen
    startDisplay.innerHTML = "";
    startHidden.innerHTML = "";
    endSelect.innerHTML = "";

    // Neue Optionen einfÃ¼gen
    for (const k of list) {
      const opt = document.createElement("option");
      opt.value = k.zeile;
      opt.textContent = `${k.zeile}. ${k.name}`;

      startDisplay.appendChild(opt);
      startHidden.appendChild(opt.cloneNode(true));

      const opt2 = opt.cloneNode(true);
      endSelect.appendChild(opt2);
    }

    // Default-Werte setzen:
    if (list.length) {
      startDisplay.value = list[0].zeile;
      startHidden.value = list[0].zeile;   // â† wichtig fÃ¼r den Server
      endSelect.value = list[list.length - 1].zeile;
    }
  }

  openBtn.addEventListener("click", () => overlay.classList.remove("hidden"));
  closeBtn.addEventListener("click", () => overlay.classList.add("hidden"));

  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) overlay.classList.add("hidden");
  });

  tbSelect.addEventListener("change", () => {
    fillKapitel(tbSelect.value);
  });
  if (tbSelect.value) {
  fillKapitel(tbSelect.value);
}
})();
</script>

  <div class="table-wrapper">
      <table class="physik-tabelle">
        <thead>
          <tr>
          <th rowspan="2">Thema / Kapitel</th>

          <th class="spacer" rowspan="2"></th>
          <th colspan="5">einfach</th>

          <th class="spacer" rowspan="2"></th>

          <th colspan="5" class="col-mittel">mittel</th>
          <th rowspan="2" class="col-mittel">Î£<br>E+M</th>

          <th class="spacer" rowspan="2"></th>

          <th colspan="5" class="col-profi">profi</th>
          <th rowspan="2" class="col-profi">Î£<br>gesamt</th>
          </tr>

          <tr>
          <th>0</th><th>1</th><th>2</th><th>3</th><th>Î£</th>
          <th class="col-mittel">0</th><th class="col-mittel">1</th><th class="col-mittel">2</th><th class="col-mittel">3</th><th class="col-mittel">Î£</th>
          <th class="col-profi">0</th><th class="col-profi">1</th><th class="col-profi">2</th><th class="col-profi">3</th><th class="col-profi">Î£</th>
          </tr>
        </thead>
        <tbody>
          {% for tb in themenbereiche %}
            {% with d=tb_totals|get_item:tb.id %}
            {% with e=d|get_item:"1"|default:0 m=d|get_item:"2"|default:0 p=d|get_item:"3"|default:0 %}
            <!-- Themenbereich -->
            <tr class="themenbereich thementitel" style="background: {{ tb.farbe }};" data-target="tb-{{ tb.id }}">
              <td class="tb-title">{{ tb.thema }}</td>

              <td class="spacer"></td>
              <!-- einfach -->
              <td></td> <td></td> <td></td> <td></td> <td class="summe">{{ e }}</td>

              <td class="spacer col-mittel"></td>
              <!-- mittel -->
              <td class="col-mittel"></td><td class="col-mittel"></td><td class="col-mittel"></td><td class="col-mittel"></td>
              <td class="summe col-mittel" >{{ m }}</td>
              <td class="summe col-mittel">{{ e|add:m }}</td>

              <td class="spacer col-profi"></td>
              <!-- profi -->
              <td class="col-profi"></td><td class="col-profi"></td><td class="col-profi"></td><td class="col-profi"></td>
              <td class="summe col-profi">{{ p }}</td>
              <!-- Î£ gesamt -->
              <td class="summe col-profi">{{ e|add:m|add:p }}</td>
            </tr>
            {% endwith %}
            {% endwith %}
            <!-- Kapitel -->
            {% for kap in tb.kapitel.all %}
              {% with tb_map=counts|get_item:tb.id %}
              {% with d=tb_map|get_item:kap.id %}
              {# d kann None sein, wenn es keine Aufgaben gibt #}
              {% with e=d|get_item:"1"|default:0 m=d|get_item:"2"|default:0 p=d|get_item:"3"|default:0 %}
                  {% if e|add:m|add:p > 0 %}
                  <tr class="kapitel tb-{{ tb.id }}">
                      <td class="kapitel-name">{{ kap.zeile }}. {{ kap.kapitel }}</td>
                      <td class="spacer"></td>
                      <!-- einfach -->
                      <td class="box leer"></td>
                      <td class="box leer"></td>
                      <td class="box leer"></td>
                      <td class="box leer"></td>
                      <td class="box leer" style="background: {{ tb.farbe }};">{{ e}}</td>

                      <td class="spacer"></td>
                      <!-- mittel -->
                      <td class="box leer col-mittel"></td>
                      <td class="box leer col-mittel"></td>
                      <td class="box leer col-mittel"></td>
                      <td class="box leer col-mittel"></td>
                      <td class="summe col-mittel" style="background: {{ tb.farbe }};">{{ m }}</td>
                      <!-- Î£ einfach + mittel -->
                      <td class="summe col-mittel" style="background: {{ tb.farbe }};">{{ e|add:m }}</td>

                      <td class="spacer col-mittel"></td>
                      <!-- profi -->
                      <td class="box leer col-profi"></td>
                      <td class="box leer col-profi"></td>
                      <td class="box leer col-profi"></td>
                      <td class="box leer col-profi"></td>
                      <td class="summe col-mittel" style="background: {{ tb.farbe }};">{{ p }}</td>
                      <!-- Î£ gesamt -->
                      <td class="summe col-profi" style="background: {{ tb.farbe }};">{{ p|add:e|add:m }}</td>
                  </tr>
                {% endif %}
              {% endwith %}
              {% endwith %}
              {% endwith %}
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <script>
      document.addEventListener("DOMContentLoaded", () => {
      const body = document.body;

      // Themenbereich-Kapitel toggeln (dein vorhandenes bleibt wie es ist)

      document.getElementById("toggle-mittel")?.addEventListener("click", () => {
          body.classList.toggle("hide-mittel");
          // wenn mittel aus -> profi automatisch aus
          if (body.classList.contains("hide-mittel")) body.classList.add("hide-profi");
      });

      document.getElementById("toggle-profi")?.addEventListener("click", () => {
          // profi darf nur an, wenn mittel sichtbar ist
          if (body.classList.contains("hide-mittel")) {
          body.classList.add("hide-profi");
          return;
          }
          body.classList.toggle("hide-profi");
      });
      });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
    // Kapitel ein-/ausklappen (hast du schon)
    document.querySelectorAll(".thementitel").forEach(function (row) {
      row.addEventListener("click", function () {
        const target = row.dataset.target;
        document.querySelectorAll("." + target).forEach(function (tr) {
          tr.classList.toggle("hidden");
        });
      });
    });
  });
  </script>
{% endblock %}
