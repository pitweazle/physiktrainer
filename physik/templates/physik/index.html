{% extends "base.html" %}
{% load static %}
{% load dict_extras %}

{% block body_classes %}
    {% with profil=request.user.physik_profil %}
        {% if 'mittel' in profil.details.versteckt %}hide-mittel hide-profi{% endif %}
        {% if 'profi' in profil.details.versteckt and 'mittel' not in profil.details.versteckt %}hide-profi{% endif %}
    {% endwith %}
{% endblock %}

{% block css_files %}
    {% comment %} <link rel="stylesheet" href="{% static 'physik/physik.css' %}"> {% endcomment %}
    <style>
        /* Grundlayout */
        body {
            background: #f2f2f2;   /* z.B. hellgrau, kannst du √§ndern */
        }

        .page-container {
            max-width: 1400px;   
            margin: 0 auto;      
            padding: 0 16px;     
            background: #ffffff;  
            transition: max-width 0.3s ease; /* NEU: sanfter √úbergang */
        }

        /* NEU: Container-Breite anpassen je nach sichtbaren Spalten */
        .hide-profi .page-container {
            max-width: 1000px;
        }

        .hide-mittel .page-container {
            max-width: 700px;
        }

        .physik-tabelle {
        width: 100%;              
        border-collapse: collapse;
        table-layout: fixed;       
        font-family: Arial, sans-serif;
        font-size: 14px;
        }

        .physik-tabelle th,
        .physik-tabelle td {
        border: 1px solid #000;
        padding: 4px 6px;
        vertical-align: middle;
        }

        /* Linien nur dort, wo sie gewollt sind */
        .physik-tabelle thead th,
        td.box,
        td.summe,
        td.kapitel-name {
            border: 1px solid #000;
        }

        /* Erste Spalte */
        .physik-tabelle th:first-child,
        .physik-tabelle td:first-child {
        width: 25%;           /* Anteilig am Desktop */
        min-width: 100px;     /* Verhindert v√∂lliges Verschwinden */
        max-width: 280px; 
        text-align: left;
        word-wrap: break-word; /* Text bricht um, wenn zu lang */
        hyphens: auto;        /* Trennt W√∂rter sauber */
        }

        /* Speziell f√ºr schmale Handys */
        @media (max-width: 600px) {
        .physik-tabelle {
            font-size: 12px;    /* Schrift etwas kleiner */
        }
        .physik-tabelle th:first-child,
        .physik-tabelle td:first-child {
            width: 120px;       /* Fixer Platz f√ºrs Thema auf dem Handy */
        }
        }

        /* Header sauberer */
        .physik-tabelle thead th {
        font-weight: bold;
        text-align: center;
        }

        /* echte Abstandsspalten ‚Äì komplett linienlos */
        td.spacer,
        th.spacer {
            width: 20px;        
            min-width: 20px;
            border: none !important;
            background: transparent !important;
            padding: 0;
        }

        /* spalten ausblenden √ºber body-klassen */
        .hide-mittel .col-mittel { display: none; }
        .hide-profi  .col-profi  { display: none; }

        .table-controls {
        margin: 8px 0 12px;
        display: flex;
        gap: 8px;
        }

        /* Themenbereich-Zeilen */
        .themenbereich td {
        font-weight: bold;
        cursor: pointer;
        color: #000;
        }

        /* Kapitel-Zeilen */
        .kapitel-name {
        text-align: left;
        }

        /* Box-Zellen gleichm√§√üig schmal */
        .box {
        width: 25px;        
        text-align: center;
        }

        /* Summen-Spalten */
        .summe {
        width: 35px;        
        text-align: center;
        }

        /* Leere Boxen leicht grau */
        .box.leer {
        background: #f2f2f2;
        }

        /* Collapse */
        .hidden {
        display: none;
        }



        .hidden { display: none; }

        .modal-overlay{
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.35);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        }
        /* sichtbar */
        .modal-overlay:not(.hidden){
        display: flex;
        }

        /* versteckt */
        .hidden{
        display: none;
        }

        .modal{
        background: #b7d8ff;
        border: 1px solid #333;
        width: 520px;
        max-width: 95vw;
        padding: 12px;
        }

        .modal-header{
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        }

        .modal-close{
        font-size: 22px;
        line-height: 22px;
        width: 32px;
        height: 32px;
        }

        .modal-body label{
        display:block;
        margin-top: 10px;
        margin-bottom: 4px;
        font-weight: bold;
        }

        .modal-body select{
        width: 100%;
        }

        .radio-row{
        display:flex;
        gap: 12px;
        }

        .modal-footer{
        margin-top: 12px;
        text-align: right;
        }



    /* Wir schreiben im Head KEIN display:none mehr f√ºr die IDs!
       Stattdessen nutzen wir die Klasse .hidden, die dein JS auch verwendet.
    */
    .hidden { display: none !important; }
</style>

<script>
    /* Wir setzen die Initial-Zust√§nde so, wie dein JS sie erwartet:
       √úber Klassen, nicht √ºber feste CSS-Regeln.
    */
    document.addEventListener("DOMContentLoaded", function() {
        const body = document.body;

        {% if profil and profil.physik_einstellungen %}
            
            // 1. Spalten-Zustand wiederherstellen
            {% if 'mittel' in profil.physik_einstellungen.versteckt %}
                body.classList.add("hide-mittel", "hide-profi");
            {% elif 'profi' in profil.physik_einstellungen.versteckt %}
                body.classList.add("hide-profi");
            {% endif %}

            // 2. Zeilen-Zustand wiederherstellen
            {% for id in profil.physik_einstellungen.zeilen_versteckt %}
                document.querySelectorAll(".{{ id }}").forEach(el => {
                    el.classList.add("hidden");
                });
            {% endfor %}

        {% endif %}
    });
</script>
{% endblock %}

{% block content %}
    <nav>
        <div class="nav-links">
            {% if user.is_staff %}
                <span class="nav-divider">| Lehrer-Tools:</span>
                
                <a href="{% url 'physik:aufgaben_liste' %}">üìã Inventar</a>
                <a href="{% url 'physik:fehler_liste' %}">üìä Analyse</a>
                <a href="{% url 'physik:howto' %}">‚ùì Anleitung (HowTo)</a>
                {% comment %} <a href="/admin/" target="_blank" class="admin-link">‚öôÔ∏è Admin</a> {% endcomment %}
                <a href="/admin/physik/aufgabe/add/" target="_blank">‚ûï Neue Aufgabe</a>
                {% comment %} <a href="/admin/physik/aufgabe/add/?next={% url 'physik:aufgaben_liste' %}" target="_blank" ...> {% endcomment %}
                <a href="#" class="btn-call" onclick="frageLfdNrAb()">üîç Aufgabe direkt aufrufen</a>
            {% endif %}
        </div>



        <script>
        function frageLfdNrAb() {
            // √ñffnet ein Eingabefenster im Browser
            let nr = prompt("Bitte die laufende Nummer eingeben (z. B. E025_Do):");
            
            // Wenn der User nicht auf "Abbrechen" geklickt hat und das Feld nicht leer ist
            if (nr && nr.trim() !== "") {
                window.location.href = "/call/" + encodeURIComponent(nr.trim()) + "/";
            }
        }
        </script>
    </nav>

    <div class="page-container">
        <h1>Physiktrainer</h1>
        <div class="table-controls">
            <p>Ein- und Ausblenden: </p>
            <button type="button" id="toggle-mittel">mittel und profi</button>
            <button type="button" id="toggle-profi">profi</button>
        </div>

        <button type="button" id="openModal">Start</button>
        <p>(Du kannst auch im gew√ºnschten Themenbereich, -Schwierigkeitsgrad und -Fachnummer auf das Endkapitel klicken)</p>

        <div id="overlay" class="modal-overlay hidden">
            <div class="modal">
                <div class="modal-header">
                    <div><strong>W√§hle Themenbereich und Schwierigkeitsgrad</strong></div>
                    <button type="button" id="closeModal" class="modal-close">√ó</button>
                </div>
                <form method="get" action="{% url 'physik:aufgaben' %}">
                    <div class="modal-body">
                        <label>Themenbereich</label>
                        <select name="tb" id="tbSelect" required>
                            <option value="">‚Äì bitte w√§hlen ‚Äì</option>
                            {% for tb in themenbereiche %}
                                <option value="{{ tb.id }}">{{ tb.thema }}</option>
                            {% endfor %}
                        </select>
                        <label>Start-Kapitel (fix)</label>
                            <select id="startSelectDisplay" disabled></select>
                            <input type="hidden" name="start" id="startSelect">
                            <label>End-Kapitel</label>
                        <select name="end" id="endSelect" required></select>
                        <hr>
                        <label>Schwierigkeitsgrad (bis:)</label>
                        <div class="radio-row">
                            <label><input type="radio" name="level" value="1"> Einfach</label>
                            <label><input type="radio" name="level" value="2" required checked> Mittel</label>
                            <label><input type="radio" name="level" value="3"> Profi</label>
                        </div>
                        <input type="hidden" name="fach" value="1">

                        <div style="background-color: #f8f9fa; border-left: 4px solid #447e9b; padding: 10px; margin-top: 15px;">
                            <p style="margin: 0; font-size: 0.9em; color: #555;">
                                <strong>Hinweis:</strong> Du startest hier in <strong>Fach 1</strong>. 
                                Um gezielt <i>Fach 2</i> oder <i>3</i> zu √ºben, w√§hle bitte die entsprechende Zahl direkt in der √úbersichtstabelle aus.
                            </p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit">weiter</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="table-wrapper">
            <table class="physik-tabelle">
                <thead>
                    <tr>
                        <th rowspan="2">Thema / Kapitel</th>
                        <th class="spacer" rowspan="2"></th>
                        <th colspan="5">einfach</th>
                        <th class="spacer" rowspan="2"></th>
                        <th colspan="5" class="col-mittel">mittel</th>
                        <th rowspan="2" class="col-mittel">Œ£<br>E+M</th>
                        <th class="spacer" rowspan="2"></th>
                        <th colspan="5" class="col-profi">profi</th>
                        <th rowspan="2" class="col-profi">Œ£<br>gesamt</th>
                    </tr>
                    <tr>
                        {# Umbenennung auf 1, 2, 3, Archiv (4) #}
                        <th>1</th><th>2</th><th>3</th><th>Archiv</th><th>Œ£</th>
                        <th class="col-mittel">1</th><th class="col-mittel">2</th><th class="col-mittel">3</th><th class="col-mittel">Archiv</th><th class="col-mittel">Œ£</th>
                        <th class="col-profi">1</th><th class="col-profi">2</th><th class="col-profi">3</th><th class="col-profi">Archiv</th><th class="col-profi">Œ£</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tb in themenbereiche %}
                        <tr class="themenbereich thementitel" style="background: {{ tb.farbe }}; cursor: pointer;" data-target="tb-{{ tb.id }}">
                            <td class="tb-title">{{ tb.thema }}</td>
                            <td class="spacer"></td>
                            <td colspan="5"></td>
                            <td class="spacer col-mittel"></td>
                            <td colspan="6" class="col-mittel"></td>
                            <td class="spacer col-profi"></td>
                            <td colspan="6" class="col-profi"></td>
                        </tr>
                        {% for kap in tb.kapitel.all %}
                            {% with tb_map=counts|get_item:tb.id %}
                            {% with kap_data=tb_map|get_item:kap.id %}
                                {% if kap_data %}
                                    <tr class="kapitel tb-{{ tb.id }}">
                                        <td class="kapitel-name">{{ kap.zeile }}. {{ kap.kapitel }}</td>
                                        <td class="spacer"></td>
                                        {# --- EINFACH (Level 1) --- #}
                                        {% with s1=kap_data|get_item:"1" %}
                                            {% with f1=s1|get_item:0|default:0 f2=s1|get_item:1|default:0 f3=s1|get_item:2|default:0 f4=s1|get_item:3|default:0 total=s1|get_item:"total"|default:0 %}
                                            {# Wir berechnen, ob schon etwas "raus" ist (Summe von Fach 2, 3 und 4) #}
                                            {% with weg=f2|add:f3|add:f4 %}
                                                <td class="box" style="background-color: 
                                                    {% if total == 0 %}transparent
                                                    {% elif f1 == 0 %}#c8e6c9; /* GR√úN: Fach 1 ist leer */
                                                    {% elif weg > 0 %}#fff9c4; /* GELB: In Arbeit (etwas ist in Fach 2+) */
                                                    {% else %}#ffcc80; /* ORANGE: Noch nichts bewegt */
                                                    {% endif %};">
                                                    {% if f1 > 0 %}
                                                        <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=1&fach=1" style="color: inherit; text-decoration: none; display: block;">
                                                            {{ f1 }}
                                                        </a>
                                                    {% else %} 0 {% endif %}
                                                </td>
                                                <td class="box col-einfach">
                                                    {% with s1=counts|get_item:tb.id|get_item:kap.id|get_item:"1" %}
                                                        {% if s1.kum_f2 > 0 %}
                                                            {% if s1.f2_ready %}
                                                                <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=1&fach=2" 
                                                                style="color: inherit; text-decoration: none; display: block;">
                                                                    {{ f2 }}
                                                                </a>
                                                            {% else %}
                                                                <span style="color: #bbb; display: block;" title="{{ s1.f2_hint }}">
                                                                    {{ f2 }}
                                                                </span>
                                                            {% endif %}
                                                        {% else %} 0 {% endif %}
                                                    {% endwith %}
                                                </td>
                                                <td class="box col-einfach">
                                                    {% with s1=counts|get_item:tb.id|get_item:kap.id|get_item:"1" %}
                                                        {% if s1.kum_f3 > 0 %}
                                                            {% if s1.f3_ready %}
                                                                <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=1&fach=3" 
                                                                style="color: inherit; text-decoration: none; display: block;">
                                                                    {{ f3 }}
                                                                </a>
                                                            {% else %}
                                                                <span style="color: #bbb; display: block;" title="{{ s1.f3_hint }}">
                                                                    {{ f3 }}
                                                                </span>
                                                            {% endif %}
                                                        {% else %} 0 {% endif %}
                                                    {% endwith %}
                                                </td>
                                                {# Fach 4 (Das Ziel) #}
                                                <td class="box" style="background-color: {% if total > 0 and f4 == total %}#4caf50{% elif f4 > 0 %}#c8e6c9{% else %}transparent{% endif %}; {% if total > 0 and f4 == total %}color: white;{% endif %}">
                                                    {{ f4 }}
                                                </td>
                                                {# Summe Level 1 #}
                                                <td class="summe" style="background: {{ tb.farbe }};">
                                                    {{ total }}
                                                </td>
                                            {% endwith %}
                                            {% endwith %}
                                        {% endwith %}

                                        <td class="spacer"></td>

                                        {# --- MITTEL (Level 2) --- #}
                                        {% with s2=kap_data|get_item:"2" %}
                                            {% with f1=s2|get_item:0|default:0 f2=s2|get_item:1|default:0 f3=s2|get_item:2|default:0 f4=s2|get_item:3|default:0 total2=s2|get_item:"total"|default:0 %}
                                            {# Hilfsvariable f√ºr Fach 1 Status #}
                                            {% with weg_aus_f1=f2|add:f3|add:f4 %}

                                            {# Fach 1 #}
                                            <td class="box col-mittel" style="background-color: {% if total2 == 0 %}transparent{% elif f1 == 0 %}#c8e6c9{% elif weg_aus_f1 > 0 %}#fff9c4{% else %}#ffcc80{% endif %};">
                                                {% if f1 > 0 %}
                                                    <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=2&fach=1" style="color: inherit; text-decoration: none; display: block;">{{ f1 }}</a>
                                                {% else %} 0 {% endif %}
                                            </td>

                                            {# Fach 2 #}
                                            <td class="box col-mittel">
                                                {% with s2=counts|get_item:tb.id|get_item:kap.id|get_item:"2" %}
                                                    {% if s2.kum_f2 > 0 %}
                                                        {% if s2.f2_ready %}
                                                            <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=2&fach=2" 
                                                            style="color: inherit; text-decoration: none; display: block;">
                                                                {{ f2 }}
                                                            </a>
                                                        {% else %}
                                                            <span style="color: #bbb; display: block;" title="{{ s2.f2_hint }}">{{ f2 }}</span>
                                                        {% endif %}
                                                    {% else %} 0 {% endif %}
                                                {% endwith %}
                                            </td>

                                            {# Fach 3 #}
                                            <td class="box col-mittel">
                                                {% with s2=counts|get_item:tb.id|get_item:kap.id|get_item:"2" %}
                                                    {% if s2.kum_f3 > 0 %}
                                                        {% if s2.f3_ready %}
                                                            <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=2&fach=3" 
                                                            style="color: inherit; text-decoration: none; display: block;">
                                                                {{ f3 }}
                                                            </a>
                                                        {% else %}
                                                            <span style="color: #bbb; display: block;" title="{{ s2.f3_hint }}">{{ f3 }}</span>
                                                        {% endif %}
                                                    {% else %} 0 {% endif %}
                                                {% endwith %}
                                            </td>

                                            {# Fach 4 (Archiv) #}
                                            <td class="box col-mittel" style="background-color: {% if total2 > 0 and f4 == total2 %}#4caf50{% elif f4 > 0 %}#c8e6c9{% else %}transparent{% endif %}; {% if total2 > 0 and f4 == total2 %}color: white;{% endif %}">
                                                {{ f4 }}
                                            </td>

                                            {# Summe Level 2 #}
                                            <td class="summe col-mittel" style="background: {{ tb.farbe }};">
                                                {{ total2 }}
                                            </td>

                                            {# Gesamtsumme (Level 1 + Level 2) #}
                                            <td class="summe col-mittel" style="background: {{ tb.farbe }}; font-weight: bold; border-left: 2px solid rgba(0,0,0,0.1);">
                                                {% with s1=kap_data|get_item:"1" %}
                                                    {% with total1=s1|get_item:"total"|default:0 %}
                                                        {{ total1|add:total2 }}
                                                    {% endwith %}
                                                {% endwith %}
                                            </td>

                                            {% endwith %}
                                            {% endwith %}
                                        {% endwith %}

                                        <td class="spacer col-mittel"></td>

                                        {# --- PROFI (Level 3) --- #}
                                        {% with s3=kap_data|get_item:"3" %}
                                            {% with f1=s3|get_item:0|default:0 f2=s3|get_item:1|default:0 f3=s3|get_item:2|default:0 f4=s3|get_item:3|default:0 total3=s3|get_item:"total"|default:0 %}
                                            {# Hilfsvariable f√ºr Fach 1 Status #}
                                            {% with weg_aus_f1=f2|add:f3|add:f4 %}
                                                {# Fach 1 #}
                                                <td class="box col-profi" style="background-color: {% if total3 == 0 %}transparent{% elif f1 == 0 %}#c8e6c9{% elif weg_aus_f1 > 0 %}#fff9c4{% else %}#ffcc80{% endif %};">
                                                    {% if f1 > 0 %}
                                                        <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=3&fach=1" style="color: inherit; text-decoration: none; display: block;">{{ f1 }}</a>
                                                    {% else %} 0 {% endif %}
                                                </td>

                                                <td class="box col-profi">
                                                    {% with s3=counts|get_item:tb.id|get_item:kap.id|get_item:"3" %}
                                                        {% if s3.kum_f2 > 0 %}
                                                            {% if s3.f2_ready %}
                                                                <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=3&fach=2" 
                                                                style="color: inherit; text-decoration: none; display: block;">
                                                                    {{ f2 }}
                                                                </a>
                                                            {% else %}
                                                                <span style="color: #bbb; display: block;" title="{{ s3.f2_hint }}">
                                                                    {{ f2 }}
                                                                </span>
                                                            {% endif %}
                                                        {% else %} 0 {% endif %}
                                                    {% endwith %}
                                                </td>

                                                <td class="box col-profi">
                                                    {% with s3=counts|get_item:tb.id|get_item:kap.id|get_item:"3" %}
                                                        {% if s3.kum_f3 > 0 %}
                                                            {% if s3.f3_ready %}
                                                                <a href="{% url 'physik:aufgaben' %}?tb={{ tb.id }}&bis_kap={{ kap.zeile }}&level=3&fach=3" 
                                                                style="color: inherit; text-decoration: none; display: block;">
                                                                    {{ f3 }}
                                                                </a>
                                                            {% else %}
                                                                <span style="color: #bbb; display: block;" title="{{ s3.f3_hint }}">
                                                                    {{ f3 }}
                                                                </span>
                                                            {% endif %}
                                                        {% else %} 0 {% endif %}
                                                    {% endwith %}
                                                </td>

                                                {# Fach 4 (Archiv/Ziel) #}
                                                <td class="box col-profi" style="background-color: {% if total3 > 0 and f4 == total3 %}#4caf50{% elif f4 > 0 %}#c8e6c9{% else %}transparent{% endif %}; {% if total3 > 0 and f4 == total3 %}color: white;{% endif %}">
                                                    {{ f4 }}
                                                </td>

                                                {# Summe Level 3 #}
                                                <td class="summe col-profi" style="background: {{ tb.farbe }};">
                                                    {{ total3 }}
                                                </td>

                                                {# Gesamtsumme (Level 1 + Level 2 + Level 3) #}
                                                <td class="summe col-profi" style="background: {{ tb.farbe }}; font-weight: bold; border-left: 2px solid rgba(0,0,0,0.1);">
                                                    {% with s1=kap_data|get_item:"1" s2=kap_data|get_item:"2" %}
                                                        {% with t1=s1|get_item:"total"|default:0 t2=s2|get_item:"total"|default:0 %}
                                                            {{ t1|add:t2|add:total3 }}
                                                        {% endwith %}
                                                    {% endwith %}
                                                </td>
                                            {% endwith %}
                                            {% endwith %}
                                        {% endwith %}                                
                                    </tr>
                                {% endif %}
                            {% endwith %}
                            {% endwith %}
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {{ kapitel_map|json_script:"kapitel-data" }}

<script>
document.addEventListener("DOMContentLoaded", () => {
    const body = document.body;

    // Hilfsfunktion zum Speichern (Spalten) - nutzt jetzt korrekt den Parameter 'slug'
    function syncSpalten(slug) {
        // WICHTIG: Hier waren die Anf√ºhrungszeichen und Plus-Zeichen falsch
        fetch(`/view-einstellung/${slug}/`) 
            .then(response => response.json())
            .then(data => console.log("Spalten gespeichert:", data))
            .catch(error => console.error("Fehler beim Speichern der Spalten:", error));
    }

    // Hilfsfunktion zum Speichern (Zeilen) - nutzt jetzt korrekt den Parameter 'slug'
    function syncZeilen(slug) {
        fetch(`/row-einstellung/${slug}/`)
            .then(response => response.json())
            .then(data => console.log("Zeile gespeichert:", data))
            .catch(error => console.error("Fehler beim Speichern der Zeile:", error));
    }

    // Event-Listener f√ºr die Buttons (Spalten)
    document.getElementById("toggle-mittel")?.addEventListener("click", function() {
        const isHidden = body.classList.toggle("hide-mittel");
        if (isHidden) body.classList.add("hide-profi");
        syncSpalten('mittel'); // Hier wird der 'slug' √ºbergeben
    });

    document.getElementById("toggle-profi")?.addEventListener("click", function() {
        if (body.classList.contains("hide-mittel")) return;
        body.classList.toggle("hide-profi");
        syncSpalten('profi');
    });

    // Event-Listener f√ºr die Themen-Balken (Zeilen)
    document.querySelectorAll(".thementitel").forEach(balken => {
        balken.onclick = function() {
            // Wir holen den Wert aus data-target (z.B. "tb-2")
            const slug = this.getAttribute("data-target"); 
            
            // Ein-/Ausblenden der Zeilen
            document.querySelectorAll("." + slug).forEach(row => {
                row.classList.toggle("hidden");
            });
            
            // Speichern im Profil
            syncZeilen(slug);
        };
    });
});
</script>

<script>
    const openBtn = document.getElementById('openModal');
    const closeBtn = document.getElementById('closeModal');
    const overlay = document.getElementById('overlay');

    // Modal √∂ffnen
    openBtn.addEventListener('click', () => {
        overlay.classList.remove('hidden');
    });

    // Modal schlie√üen (beim X)
    closeBtn.addEventListener('click', () => {
        overlay.classList.add('hidden');
    });

    // Optional: Schlie√üen, wenn man au√üerhalb des Fensters klickt
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
            overlay.classList.add('hidden');
        }
    });
</script>

<script>
// 1. Die kapitel_map direkt aus Django √ºbernehmen
// 'safe' sorgt daf√ºr, dass die Anf√ºhrungszeichen nicht in HTML-Entities umgewandelt werden
const kapitelData = {{ kapitel_map|safe }};

document.addEventListener("DOMContentLoaded", () => {
    const tbSelect = document.getElementById('tbSelect');
    const endSelect = document.getElementById('endSelect');
    const startDisplay = document.getElementById('startSelectDisplay');
    const startHidden = document.getElementById('startSelect');

    tbSelect.addEventListener('change', function() {
        const selectedTbId = this.value;
        const gefiltert = kapitelData[selectedTbId] || [];

        // Dropdown f√ºr End-Kapitel leeren
        endSelect.innerHTML = '<option value="">‚Äì bitte w√§hlen ‚Äì</option>';
        
        if (gefiltert.length > 0) {
            // 1. Start-Kapitel setzen (das erste Element aus der Liste)
            // Wir nehmen gefiltert[0].name, weil dein Backend {"name": ...} liefert
            startDisplay.innerHTML = `<option>${gefiltert[0].name}</option>`;
            startHidden.value = gefiltert[0].zeile;

            // 2. End-Kapitel Dropdown bef√ºllen
            gefiltert.forEach(k => {
                const opt = new Option(k.name, k.zeile);
                endSelect.add(opt);
            });
            
            // 3. Das letzte Kapitel als Standard f√ºr "Ende" vorw√§hlen
            endSelect.value = gefiltert[gefiltert.length - 1].zeile;
        } else {
            // Falls keine Kapitel vorhanden sind
            startDisplay.innerHTML = '';
            startHidden.value = '';
        }
    });
});
</script>

{% endblock %}